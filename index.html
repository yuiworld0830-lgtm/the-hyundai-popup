<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>지금, 더현대 서울</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .hide-scroll::-webkit-scrollbar { display: none; }
        html { scroll-behavior: smooth; }
        .carousel { scroll-behavior: smooth; }
    </style>
</head>
<body class="bg-gray-50 flex">
    
    <nav class="fixed left-0 top-0 h-full w-14 md:w-16 bg-white border-r border-gray-200 flex flex-col items-center pt-24 space-y-5 z-40 shadow-sm text-sm md:text-base">
        <a href="#B2" class="font-black text-gray-400 hover:text-emerald-600 transition-colors">B2</a>
        <a href="#B1" class="font-black text-gray-400 hover:text-emerald-600 transition-colors">B1</a>
        <a href="#1F" class="font-black text-gray-400 hover:text-emerald-600 transition-colors">1F</a>
        <a href="#2F" class="font-black text-gray-400 hover:text-emerald-600 transition-colors">2F</a>
        <a href="#3F" class="font-black text-gray-400 hover:text-emerald-600 transition-colors">3F</a>
        <a href="#4F" class="font-black text-gray-400 hover:text-emerald-600 transition-colors">4F</a>
        <a href="#5F" class="font-black text-gray-400 hover:text-emerald-600 transition-colors">5F</a>
        <a href="#6F" class="font-black text-gray-400 hover:text-emerald-600 transition-colors">6F</a>
    </nav>

    <div class="ml-14 md:ml-16 w-full pb-24">
        <header class="p-5 md:p-6 bg-white/90 backdrop-blur shadow-sm flex justify-between items-center sticky top-0 z-30">
            <h1 class="text-xl md:text-2xl font-black italic tracking-tighter text-gray-900">지금, <span class="text-emerald-600">더현대 서울</span></h1>
            <div id="status-dot" class="w-3 h-3 rounded-full bg-red-500 animate-pulse"></div>
        </header>

        <main id="app" class="p-4 space-y-16 mt-2 border-box max-w-7xl mx-auto">
            <div id="msg" class="py-20 text-center text-gray-500 font-bold animate-pulse">데이터를 읽는 중입니다...</div>
        </main>
    </div>

    <script>
        // 에러가 나면 화면에 바로 띄워서 멈춤을 방지하는 안전장치
        window.onerror = function(message) {
            document.getElementById('msg').innerHTML = "시스템 에러: " + message;
            document.getElementById('status-dot').classList.replace('animate-pulse', 'bg-red-500');
        };

        async function init() {
            const app = document.getElementById('app');
            const msg = document.getElementById('msg');
            const dot = document.getElementById('status-dot');

            try {
                // 1. 캐시(과거 기록) 무시하고 무조건 최신 data.csv 가져오기 (시간표시 난수 추가)
                const res = await fetch('data.csv?t=' + new Date().getTime());
                if (!res.ok) throw new Error("data.csv 파일을 찾을 수 없습니다.");
                
                let text = await res.text();
                text = text.replace(/^\uFEFF/, ''); // 엑셀 깨짐 방지용 특수문자 제거
                
                // 2. 외부 도구 없이 데이터를 한 줄씩 쪼개서 직접 읽기
                const lines = text.split(/\r?\n/).filter(line => line.trim() !== '');
                if (lines.length < 2) throw new Error("데이터가 비어있습니다. 엑셀을 확인해주세요.");

                const headers = lines[0].split(',').map(h => h.trim().replace(/^"|"$/g, ''));
                
                // 각 열이 몇 번째인지 자동으로 찾기
                const col = {
                    floor: headers.findIndex(h => h.includes('층')),
                    space: headers.findIndex(h => h.includes('공간')),
                    name: headers.findIndex(h => h.includes('이름') || h.includes('팝업')),
                    start: headers.findIndex(h => h.includes('시작')),
                    end: headers.findIndex(h => h.includes('종료')),
                    img: headers.findIndex(h => h.includes('이미지'))
                };

                const allowedFloors = ["B2", "B1", "1F", "2F", "3F", "4F", "5F", "6F"];
                const groupedData = {};
                allowedFloors.forEach(f => groupedData[f] = {});
                let hasData = false;

                const now = new Date();
                now.setHours(0,0,0,0);

                for (let i = 1; i < lines.length; i++) {
                    // CSV 쉼표 정확하게 분리하기
                    let cols = [];
                    let inQuotes = false;
                    let current = '';
                    for (let char of lines[i]) {
                        if (char === '"') inQuotes = !inQuotes;
                        else if (char === ',' && !inQuotes) { cols.push(current); current = ''; }
                        else current += char;
                    }
                    cols.push(current);
                    cols = cols.map(c => c.replace(/^"|"$/g, '').trim());

                    const floor = col.floor !== -1 && cols[col.floor] ? cols[col.floor].toUpperCase() : '';
                    if (!allowedFloors.includes(floor)) continue;

                    const space = col.space !== -1 && cols[col.space] ? cols[col.space] : '팝업 공간';
                    const title = col.name !== -1 && cols[col.name] ? cols[col.name] : '이름 없음';
                    const img = col.img !== -1 && cols[col.img] ? cols[col.img] : '';
                    
                    const startStr = col.start !== -1 && cols[col.start] ? cols[col.start] : '';
                    const endStr = col.end !== -1 && cols[col.end] ? cols[col.end] : '';

                    const startDate = startStr ? new Date(startStr) : new Date();
                    const endDate = endStr ? new Date(endStr) : new Date();

                    let statusObj = { text: '진행중', color: 'bg-emerald-500', class: 'status-ongoing', opacity: '' };
                    if (now > endDate) {
                        statusObj = { text: '종료됨', color: 'bg-gray-400', class: 'status-past', opacity: 'opacity-50 grayscale' };
                    } else if
